---
title: "データベースを使う"
---

## Webアプリケーションとデータ

多くのWebアプリケーションはユーザから何らかの入力を受け取り、保存している。例えばユーザ名・パスワードのようなものから、そのサービス特有のデータまで様々な物を取り扱う。

もしアプリケーションのメモリ内だけにそのデータがある場合、単にプロセスを再起動するだけでそのデータは失われてしまう[^inmem]。このようなシステムのメンテナンスは著しく困難である。

[^inmem]: Redisやその互換インメモリKVSであるDragonflyはメモリ内にデータを保存するが、レプリケーションをサポート（[ref](https://redis.io/docs/management/replication/), [ref](https://redis.io/docs/management/replication/)）することで複数インスタンスのメモリ上に同じデータが存在するように設定できる。これにより、サービスメンテナンス時にもデータを失わずに済む。このようなレプリケーションの実装は一般に難しく、アプリケーションが自前で実装することは避けるべきである。

ローカルファイルシステムにデータを永続化することもできるが、そのファイルシステムへ複数のプロセス・VM・物理マシンが同時にアクセスできるようにするのは容易ではない。NFSやSambaなどを用いてネットワーク越しに共有ディスクをマウントすることで複数のプロセスが同じデータにアクセス出来るようになるが、整合性の問題を引き起こす可能性がある[^nfsinprod]。

[^nfsinprod]: 例えばSQLiteデータベースをNFS上に配置すると整合性がとれなくなることがある（[ref](https://www.sqlite.org/faq.html#q5)）。NFSの実装ではファイルロックを正しく扱えないことに起因しており、SQLiteを使わず独自にデータストアを実装する場合でも複数のプロセス間でどのようにロックを取るかを考慮する必要がある。そのような実装は一般に難しく、アプリケーションが自前で実装することは避けるべきである。

そのため多くのWebアプリケーションはデータの保存に専用のミドルウェアを用いる。最も一般的なのはリレーショナルデータベースシステム（RDBMS）である。RDBMSはデータの永続化だけでなく、データの整合性を保つためのトランザクション機構や、データの検索を高速化するためのインデックス機構を提供する。またメンテナンスや負荷分散・障害対策の観点からデータのレプリケーション機能を提供することもある。
本書ではRDBMSの一つであるMySQLをとりあげ、MySQLを用いるサンプル実装を通じてデータベースを使う際の注意点やデータベースを冗長化する方法を説明する。

## サンプルのTODOアプリケーション

本書では筆者が実装した以下のアプリケーションを用いる。

@[card](https://github.com/pddg/go-sample-todo)

このアプリケーションは以下の様な機能を持つ。

- `GET /todo`
    - 登録されたTODOを全て取得する
    - 例：`curl localhost:8080/todo`
- `POST /todo`
    - 新しいTODOを登録する
    - 例：`curl -X POST -d '{"task":"new todo"}' localhost:8080/todo`
- `DELETE /todo/:id`
    - 指定したIDのTODOを削除する
    - 例：`curl -X DELETE localhost:8080/todo/1`
- `POST /initialize`
    - データベースを初期化する
    - 例：`curl -X POST localhost:8080/initialize`


