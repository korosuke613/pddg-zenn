---
title: "サービスが落ちる要因"
---

## サービスの可用性はいつ落ちるのか

ここではWebサービスを提供するサーバが1台だけあると考えたとき、どのようなタイミングでサービスの提供が出来なくなるのかを考えてみます。
経路上のネットワーク機器は故障しない、インターネットからのアクセスは確保されており途絶えることはない、など外部要因を除くと以下の様な物が考えられます（これらは例であり全てではありません）。

### ハードウェア起因

サーバの物理マシンの故障などを指します。故障にも様々なタイプがあり、完全に壊れてしまい電源が入らなくなるものから、ネットワーク接続が時折途絶えたり、排気ファンが壊れて温度が高まりCPUのクロック周波数が低下したことで処理能力が落ちるようなケースまで様々な要因が考えられます。
ハードウェア故障の難しいところは、その予測の難しさと壊れたときの挙動がソフトウェアのそれとは大きく異なることが多いところです。誰でも家電やPCを買ったとき、それがいつ壊れるかはわからないものです。また、一部だけが急に壊れたことで人の目から見ると不可解な動作をすることも多くあります。常に同じ対処で対応が可能とは限らず、アドホックな対応が求められることもあります。

残念ながら壊れないハードウェアはないため、Webサービスにおいてハードウェア故障から逃れることはできません。堅牢なサービスを提供しているパブリッククラウドプロバイダーであっても、その裏側ではどんどんハードウェアが故障しているはずです。

### パフォーマンス起因

用意したコンピューティングリソースの許容量を超える負荷によって既存もしくは新規のリクエストを処理できなくなったときを指します。CPUのリソースを使い切った場合や、メモリを使い切った場合など様々なケースが考えられます。
具体的には、高負荷なサービスに貧弱なサーバを使ってしまうといったキャパシティプランニング[^cap-plan]の問題や、時間計算量が `O(n^3)` のアルゴリズム[^on3]によってリクエストの処理量が爆発してCPUを使い切った場合のようなロジックの問題などがあります。

[^cap-plan]: ここでキャパシティプランニングとは、そのサービスに必要な量のコンピューティングリソース・およびその構成などを見積もることを指します。
[^on3]: これは別に時間計算量だけの問題ではありません。例えば空間計算量が問題になっている場合でも同様です。サーバ上のメモリリソースは有限であり、これを使い切ることでサービスが新規のリクエストを処理出来なくなる可能性があります。

これらはユーザの努力によって避けることができる場合もありますが、予測できないところで問題が発生するケースもあり得ます。急にSNSでバズって予測できなかった量のリクエストが唐突に発生するなどは避けることが難しいでしょう。

### メンテナンス起因

メンテナンスとは、サービスの運用・保守に必須の作業です。また保守のみならず、新しいバージョンのサービスのデプロイなどもここに含めて考えることができます。
ケースバイケースではありますが、基本的にメンテンスではサービスは止まってしまいます。いくつかの例を以下に示します。

- アプリケーションの更新に伴うプロセスの再起動
  - 例：APIサーバの新しいバージョンを適用するために動いているサービスを止め新しいバージョンで立ち上げ直した
- OSやライブラリの更新に伴うOSの再起動
  - 例：Ubuntu 20.04のサポートが切れる前にUbuntu 22.04への更新をした
- 物理マシンのファームウェアアップデート
  - 例：サーバのBIOSのバージョンに脆弱性が見つかったので更新するためマシンを再起動した
- 物理マシンの退役
  - 例：保守期間が迫っている古い機材から、新規に購入した新しい機材へ交換した

これらをいずれもやらず、塩漬けにすることはもちろん可能ですが、古くなったハードウェアはいずれ故障します。脆弱性を突かれて攻撃されると情報漏洩などの危険性もあります。なにより進化しないサービスでユーザを維持し続けることは現代では難しく、新しい機能を追加してより便利にしたり、不具合を修正することは実際には必須と言えるでしょう。

まとめると、サービスが利用可能な状態になっているためには、コンピューティングリソースが提供可能な状態になっていること、それらの上で必要なプロセスが正しく動作していることが重要です。
どちらかが欠けても可用性は損なわれてしまいます。

## 可用性を落とさずにメンテンスしたい

ハードウェア・パフォーマンス起因の問題はいずれも大きな問題ではありますが、一旦本書ではフォーカスから外しメンテナンス起因の問題に着目します。
メンテンスはWebサービスを運用する上で必ず発生します。メンテナンスを避けるべきではなく、むしろ積極的にできる体制にしておかなければいけません。迅速なメンテナンスができない環境では長時間脆弱性の脅威に晒されたり、必要な更新ができなかったりする可能性が高いです。

メンテナンスの度にユーザのリクエストを処理出来なくなってしまうとすると、商用のサービスではそれなりに致命的です。例えばイベント開催中のソーシャルゲームに不具合が見つかったとしましょう。このゲームにおいてイベントは稼ぎ時です。イベントを中断して不具合を修正することは金銭的なインパクトがあり、会社の減益に繋がるかも知れません。一方でこの不具合を修正しなかった場合、ユーザはゲームに嫌気がさして離れていってしまうかもしれません。このような場合でもサービスを止めずにメンテナンス可能な体制を整えておけば、素早く変更を適用してユーザを満足させつつサービスを続けることができるようになります[^maint]。

[^maint]: もちろん、ここでサービスを一旦停止してでもメンテナンスを行うという判断が必ずしも悪いわけではありません。特に脆弱性対応などではユーザへの事前の通告無しにサービス停止を伴うようなメンテナンスを行うこともあり得ます。放置したり告知することによってユーザに不利益が生じる可能性もあるからです。

以降の章ではこのようなメンテナンスを積極的に可能にするアーキテクチャ・技術について簡単に学び、実際に実践していきましょう。
