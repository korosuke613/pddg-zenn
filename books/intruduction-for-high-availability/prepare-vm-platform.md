---
title: "仮想サーバ基盤を構築する"
---

## 物理マシンでサービスを提供する

物理マシンにOSをインストールし、Webサーバを入れ、サービスを提供することももちろん可能です。余計なオーバーヘッドもなく、パフォーマンスも良いかも知れません。
一方で、この構成はメンテナンスが難しくなることもあります。

- 一つのOS内に様々なものがインストールされているとアップデート時や再起動時に考慮が必要なものが多くなる
  - あるライブラリやランタイムの更新時にそれによって影響を受ける範囲をしっかり考慮しなければならない
  - 同じPythonを使うソフトウェアでも、それらが要求するバージョンなどは異なるかもしれない
- 物理マシンは再起動にかかるコストが重い
  - ハードウェア周りの処理が入るためサーバの起動には時間がかかる
  - 再起動を要するメンテナンスにかかる時間が長くなるためあまり頻繁に実施したくない

とはいえ物理マシンは大抵高いスペックを持つため一台あたりが高価であり、依存関係のためだけにわざわざ複数台の物理マシンを用意するのは現実的とは言えません。この高スペックを活かし、かつコンポーネント間を疎結合にして管理しやすくする方法は無いものでしょうか？
そのために必要な概念としてコンピューティングリソースの抽象化について考えて見ます。

### コンピューティングリソースの割り振りとコンポーネントの分離

まずコンピューティングリソースとはCPUやメモリ・ディスクの容量など、物理マシンがサービス提供に供与可能なリソース量を指します。ここに4コア、32GBメモリ、256GBのディスク容量があるサーバが3台あるとき、利用可能なコンピューティングリソースとしては12コア、96GBメモリ、768GBのディスクがある事になります。ただしこの96GBのメモリが単一のプロセスで利用可能なわけでは無いことには注意が必要です。

物理マシンが単なるコンピューティングリソースを供与するものであると考えると、反対にサービスを提供するプロセスはコンピューティングリソースを消費するものに当たります。プロセスがどれくらいリソースを消費するかを考慮した上でそれが実現できる物理マシンに適切に配置することが重要です。ここでは複数あるサーバ一つ一つは単なるコンピューティングリソースの塊であって、どのプロセスがどこに配置されるかは単にコンピューティングリソースの都合によって決まります。

ただし単にプロセスを配置すると言っても、やり方を考えなければ前述したように一つの物理マシンの中で複雑に絡まり合い、メンテナンスを困難にしてしまいます。そこで、仮想的な「箱」を用意し、その「箱」に対してリソースを割り当てることを考えます。この「箱」は他の「箱」や「箱」を収容するホストに直接干渉することはできず、それらが利用可能なリソース以上にリソースを利用できないようになっているとします。

この状態では、各「箱」ごとにメンテナンスが可能になります。またコンピューティングリソースの割り振りを変えることで、各「箱」の使えるリソース量を変更することもできます。
この一つ一つの「箱」を仮想的なサーバ=**仮想サーバ（VM）**と呼びます。Linuxには仮想サーバを作るための機能があり、適切に利用することでホストのコンピューティングリソースを仮想サーバごとにそれぞれ割り振ることができるようになっています。

## 仮想サーバ（VM）とは

VM（Virtual Machineの略）とは「仮想マシンは、実際のコンピューターのように動作するコンピューター ファイル」[^ms-vm-dev]です。これらは普通にサーバを使っている時のようにCPU・メモリ・ディスクなどを持ち、ネットワークで通信することが出来ますが、その実体は物理マシンのリソースを抽象化したものを操っており物理的に目に見えるものではありません。

[^ms-vm-def]: https://azure.microsoft.com/ja-jp/resources/cloud-computing-dictionary/what-is-a-virtual-machine

## なぜVMを用いるのか

- アプリケーションやミドルウェアの実行環境の分離のため
- 物理マシンは柔軟な管理が難しく管理のコストが大きいため

## 様々なサーバ仮想化製品

- Windows Hyper-V
- Linux KVM
- VirtualBox
- VMware ESXi
- Proxmox VE

今回はフリーのProxmox VEを用いてVM基盤を構築する。まずは中身については触れず、実際にVMを作って遊ぶ。

